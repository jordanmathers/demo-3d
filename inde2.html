<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>3d Demo</title>

    <!-- Assembly CSS-->
    <link href='https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.min.css' rel='stylesheet'>
    <script async defer src='https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.js'></script>

    <!-- Mapbox GL -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 200px;
            top: 0;
            left: 0;
            padding: 10px;
        }

        .map-overlay .map-overlay-inner {
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay-inner fieldset {
            border: none;
            padding: 0;
            margin: 0 0 10px;
        }

        .map-overlay-inner fieldset:last-child {
            margin: 0;
        }

        .map-overlay-inner select {
            width: 100%;
        }

        .map-overlay-inner label {
            display: block;
            font-weight: bold;
            margin: 0 0 5px;
        }

        .map-overlay-inner button {
            display: inline-block;
            width: 36px;
            height: 20px;
            border: none;
            cursor: pointer;
        }

        .map-overlay-inner button:focus {
            outline: none;
        }

        .map-overlay-inner button:hover {
            box-shadow: inset 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .map-overlay-inner div span {
            border-radius: 20%;
            display: inline-block;
            height: 12px;
            margin-right: 10px;
            width: 12px;
        }
    </style>
</head>

<body>

    <div id='map' class='map'></div>

    <div class="map-overlay top">
        <div class="map-overlay-inner">
            <fieldset>
                <label>Select layer</label>
                <select id="selectedLayer" name="layer">
                    <option value="existing">Existing</option>
                    <option value="option01">Option 01</option>
                    <option value="option02">Option 02</option>
                    <option value="option03">Option 03</option>
                </select>
            </fieldset>
            <fieldset>
                <label>Style</label>
                <select id="selectedStyle" name="style">
                    <option value="default">Default</option>
                    <option value="storeys">Storeys</option>
                    <option value="height">Height</option>
                    <option value="area">Area</option>
                </select>
            </fieldset>
            <fieldset>
                <div id="legend-gradient" style="display: none;">
                    <label>Legend</label>
                    <div class="h12" id="gradient"></div>
                    <div class='grid txt-xs'>
                        <div id="legend-low" class='flex-child flex-child--grow align-l'>Low</div>
                        <div id="legend-high" class='flex-child flex-child--grow align-r'>High</div>
                    </div>
                </div>
                <div id="legend-stepped" style="display: none;">
                    <label>Legend 2</label>
                    <div><span style="background-color: #723122"></span>25,000,000</div>
                    <div><span style="background-color: #8B4225"></span>10,000,000</div>
                    <div><span style="background-color: #A25626"></span>7,500,000</div>
                    <div><span style="background-color: #B86B25"></span>5,000,000</div>
                    <div><span style="background-color: #CA8323"></span>2,500,000</div>
                    <div><span style="background-color: #DA9C20"></span>1,000,000</div>
                </div>
            </fieldset>
        </div>
    </div>

    <script>

        mapboxgl.accessToken = 'pk.eyJ1Ijoiam9yZGFubWF0aGVyc2ptIiwiYSI6ImNqdTRxZWlibjEwbWIzeXBkb2Qyc25wN2sifQ.tr6sRzjF303FcCrNelUlXg';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [151.214160, -33.881191],
            pitch: 60,
            bearing: -45,
            zoom: 17
        });

        map.on('load', function () {

            var layers = ['context', 'existing', 'option01', 'option02', 'option03']

            layers.forEach(function (layer) {

                var opacity = 0.8;
                var color = '#f0f0f0';
                var visible = 'visible';

                if (layer == 'context') {
                    opacity = 0.6;
                }

                if (layer != 'existing' && layer != 'context') {
                    visible = 'none'
                }

                map.addSource(layer + '-s', {
                    'type': 'geojson',
                    'generateId': true,
                    'data':
                        'https://raw.githubusercontent.com/jordanmathers/demo-3d/master/data/options/' + layer + '.geojson'
                });

                map.addLayer({
                    'id': layer,
                    'type': 'fill-extrusion',
                    'source': layer + '-s',
                    'layout': { 'visibility': visible },
                    'paint': {
                        'fill-extrusion-height': ['get', 'height'],
                        'fill-extrusion-base': ['get', 'min_height'],
                        'fill-extrusion-opacity': opacity,
                        'fill-extrusion-color': [
                            'case',
                            ['boolean', ['feature-state', 'clicked'], false],
                            '#045a8d',
                            color
                        ]
                    }
                });

                var buildingId = null;
                map.on('click', layer, function (e) {
                    if (e.features.length > 0) {
                        if (buildingId) {
                            map.setFeatureState(
                                { source: layer + '-s', id: buildingId },
                                { clicked: false }
                            );
                        }
                        buildingId = e.features[0].id;
                        map.setFeatureState(
                            { source: layer + '-s', id: buildingId },
                            { clicked: true }
                        );
                    }
                });

                map.on('mouseenter', layer, function () {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', layer, function () {
                    map.getCanvas().style.cursor = '';
                });
            })

            var selectedLayer = document.getElementById('selectedLayer');

            selectedLayer.onchange = function () {

                var layerval = selectedLayer.value;

                if (layerval === 'existing') {
                    var others = ['option01', 'option02', 'option03']
                } else if (layerval === 'option01') {
                    var others = ['existing', 'option02', 'option03']
                } else if (layerval === 'option02') {
                    var others = ['existing', 'option01', 'option03']
                } else {
                    var others = ['existing', 'option01', 'option02']
                };

                var visibility = map.getLayoutProperty(layerval, 'visibility');

                if (visibility !== 'visible') {
                    map.setLayoutProperty(layerval, 'visibility', 'visible');

                    others.forEach(function (lay) {
                        map.setLayoutProperty(lay, 'visibility', 'none');
                    });
                };
            };

            var styleArray = {
                'area': {
                    'colors': ['#edf8fb', '#bfd3e6', '#9ebcda', '#8c96c6', '#8856a7', '#810f7c'],
                    'steps': [0, 1000, 2000, 3000, 4000, 5000]
                },
                'storeys': {
                    'colors': ['#ffffcc', '#c7e9b4', '#7fcdbb', '#41b6c4', '#2c7fb8', '#253494'],
                    'steps': [0, 2, 4, 6, 8, 10]
                },
                'height': {
                    'colors': ['#f1eef6', '#d4b9da', '#c994c7', '#df65b0', '#dd1c77', '#980043'],
                    'steps': [0, 25, 50, 75, 100, 125]
                }
            }

            var legendStops = [00, 20, 40, 60, 80, 100];

            var selectedStyle = document.getElementById('selectedStyle');
            var gradientLegend = document.getElementById('legend-gradient');
            var steppedLegend = document.getElementById('legend-stepped');

            var styleLeg = null;

            selectedStyle.onchange = function () {

                var styleVal = selectedStyle.value;
                
                gradientLegend.style.display = 'none';
                steppedLegend.style.display = 'none';

                if (styleVal == 'area') {
                    styleLeg = styleArray.area;
                    gradientLegend.style.display = 'block';
                } else if (styleVal == 'storeys') {
                    styleLeg = styleArray.storeys;
                    gradientLegend.style.display = 'block';
                } else if (styleVal == 'height') {
                    styleLeg = styleArray.height;
                    gradientLegend.style.display = 'block';
                } else {
                    gradientLegend.style.display = 'none';
                };

                if (styleVal == 'height') {
                    var styler = [
                        'interpolate',
                        ['linear'],
                        ['get', 'tot_height'],
                        styleLeg.steps[0], styleLeg.colors[0],
                        styleLeg.steps[1], styleLeg.colors[1],
                        styleLeg.steps[2], styleLeg.colors[2],
                        styleLeg.steps[3], styleLeg.colors[3],
                        styleLeg.steps[4], styleLeg.colors[4],
                        styleLeg.steps[5], styleLeg.colors[5],
                    ];
                    var styler_context = [
                        'interpolate',
                        ['linear'],
                        ['get', 'height'],
                        styleLeg.steps[0], styleLeg.colors[0],
                        styleLeg.steps[1], styleLeg.colors[1],
                        styleLeg.steps[2], styleLeg.colors[2],
                        styleLeg.steps[3], styleLeg.colors[3],
                        styleLeg.steps[4], styleLeg.colors[4],
                        styleLeg.steps[5], styleLeg.colors[5],
                    ];
                } else if (styleVal == 'default') {
                    var styler = [
                        'case',
                        ['boolean', ['feature-state', 'clicked'], false],
                        '#045a8d',
                        '#f0f0f0'
                    ];
                } else {
                    var styler = [
                        'interpolate',
                        ['linear'],
                        ['get', styleVal],
                        styleLeg.steps[0], styleLeg.colors[0],
                        styleLeg.steps[1], styleLeg.colors[1],
                        styleLeg.steps[2], styleLeg.colors[2],
                        styleLeg.steps[3], styleLeg.colors[3],
                        styleLeg.steps[4], styleLeg.colors[4],
                        styleLeg.steps[5], styleLeg.colors[5],
                    ];
                };

                map.setPaintProperty(selectedLayer.value, 'fill-extrusion-color', styler);
                if (styleVal == 'height') {
                    map.setPaintProperty('context', 'fill-extrusion-color', styler_context);
                } else {
                    map.setPaintProperty('context', 'fill-extrusion-color', styler);
                };

                $('#legend-low').text(styleLeg.steps[0]);
                $('#legend-high').text(styleLeg.steps[styleLeg.steps.length - 1]);

                var gradientCss = '(left';

                for (var i = 0; i < styleLeg.colors.length; ++i) {
                    gradientCss += ',' + styleLeg.colors[i] + ' ' + legendStops[i] + "%";
                    $('#gradient').css('background', '-webkit-linear-gradient' + gradientCss);
                };
            };
        });

    </script>

    <!-- Load Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

</body>

</html>