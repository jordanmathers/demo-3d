<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>3d Demo</title>

    <!-- Assembly CSS-->
    <link href='https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.min.css' rel='stylesheet'>
    <script async defer src='https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.js'></script>

    <!-- Mapbox GL -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 200px;
            top: 0;
            left: 0;
            padding: 10px;
        }

        .map-overlay .map-overlay-inner {
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay-inner fieldset {
            border: none;
            padding: 0;
            margin: 0 0 10px;
        }

        .map-overlay-inner fieldset:last-child {
            margin: 0;
        }

        .map-overlay-inner select {
            width: 100%;
        }

        .map-overlay-inner label {
            display: block;
            font-weight: bold;
            margin: 0 0 5px;
        }

        .map-overlay-inner button {
            display: inline-block;
            width: 36px;
            height: 20px;
            border: none;
            cursor: pointer;
        }

        .map-overlay-inner button:focus {
            outline: none;
        }

        .map-overlay-inner button:hover {
            box-shadow: inset 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .map-overlay-inner div span {
            border-radius: 20%;
            display: inline-block;
            height: 12px;
            margin-right: 10px;
            width: 12px;
        }
    </style>
</head>

<body>

    <div id='map' class='map'></div>

    <div class="map-overlay top">
        <div class="map-overlay-inner">
            <fieldset>
                <label>Select layer</label>
                <select id="layer" name="layer">
                    <option value="existing">Existing</option>
                    <option value="opt01">Option 01</option>
                    <option value="opt02">Option 02</option>
                    <option value="opt03">Option 03</option>
                </select>
            </fieldset>
            <fieldset>
                <label>Style</label>
                <select id="style" name="style">
                    <option value="nostyling">Default</option>
                    <option value="area">Area (GFA)</option>
                    <option value="levels">Storeys</option>
                    <option value="levels">Height</option>
                </select>
            </fieldset>
            <fieldset>
                <div id="legend-gradient" style="display: none;">
                    <label>Legend</label>
                    <div class="h12" id="gradient"></div>
                    <div class='grid txt-xs'>
                        <div id="legend-low" class='flex-child flex-child--grow align-l'>Low</div>
                        <div id="legend-mid" class='flex-child--no-shrink w120 align-center'>Mid</div>
                        <div id="legend-high" class='flex-child flex-child--grow align-r'>High</div>
                    </div>
                </div>
                <div id="legend-stepped" style="display: none;">
                    <label>Legend 2</label>
                    <div><span style="background-color: #723122"></span>25,000,000</div>
                    <div><span style="background-color: #8B4225"></span>10,000,000</div>
                    <div><span style="background-color: #A25626"></span>7,500,000</div>
                    <div><span style="background-color: #B86B25"></span>5,000,000</div>
                    <div><span style="background-color: #CA8323"></span>2,500,000</div>
                    <div><span style="background-color: #DA9C20"></span>1,000,000</div>
                    <div><span style="background-color: #E6B71E"></span>750,000</div>
                    <div><span style="background-color: #EED322"></span>500,000</div>
                    <div><span style="background-color: #F2F12D"></span>0</div>
                </div>
            </fieldset>
        </div>
    </div>

    <script>

        mapboxgl.accessToken = 'pk.eyJ1Ijoiam9yZGFubWF0aGVyc2ptIiwiYSI6ImNqdTRxZWlibjEwbWIzeXBkb2Qyc25wN2sifQ.tr6sRzjF303FcCrNelUlXg';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [151.214160, -33.881191],
            pitch: 60,
            bearing: -45,
            zoom: 17
        });

        map.on('load', function () {

            var layers = ['existing', 'option01', 'option02', 'option03']

            layers.forEach(function (layer) {

                map.addSource(layer, {
                    'type': 'geojson',
                    'generateId': true,
                    'data':
                        'https://raw.githubusercontent.com/jordanmathers/demo-3d/master/data/context.geojson'
                });
            })

            map.addSource('context-s', {
                'type': 'geojson',
                'generateId': true,
                'data':
                    'https://raw.githubusercontent.com/jordanmathers/demo-3d/master/data/context.geojson'
            });

            map.addSource('existing-s', {
                'type': 'geojson',
                'generateId': true,
                'data':
                    'https://raw.githubusercontent.com/jordanmathers/demo-3d/master/data/options/01_ex.geojson'
            });

            map.addSource('opt01-s', {
                'type': 'geojson',
                'generateId': true,
                'data':
                    'https://raw.githubusercontent.com/jordanmathers/demo-3d/master/data/options/02_opt1a.geojson'
            });

            map.addSource('opt02-s', {
                'type': 'geojson',
                'generateId': true,
                'data':
                    'https://raw.githubusercontent.com/jordanmathers/demo-3d/master/data/options/03_opt2a.geojson'
            });

            map.addSource('opt03-s', {
                'type': 'geojson',
                'generateId': true,
                'data':
                    'https://raw.githubusercontent.com/jordanmathers/demo-3d/master/data/options/04_opt3a.geojson'
            });

            map.addLayer({
                'id': 'context',
                'type': 'fill-extrusion',
                'source': 'context-s',
                'paint': {
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.7,
                    'fill-extrusion-color':
                        '#f0f0f0'
                }
            });

            map.addLayer({
                'id': 'existing',
                'type': 'fill-extrusion',
                'source': 'existing-s',
                'paint': {
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.7,
                    'fill-extrusion-color': [
                        'case',
                        ['boolean', ['feature-state', 'clicked'], false],
                        '#045a8d',
                        '#cccccc'
                    ]
                }
            });

            map.addLayer({
                'id': 'opt01',
                'type': 'fill-extrusion',
                'source': 'opt01-s',
                'layout': { 'visibility': 'none' },
                'paint': {
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.7,
                    'fill-extrusion-color': [
                        'case',
                        ['boolean', ['feature-state', 'clicked'], false],
                        '#045a8d',
                        '#cccccc'
                    ]
                }
            });

            map.addLayer({
                'id': 'opt02',
                'type': 'fill-extrusion',
                'source': 'opt02-s',
                'layout': { 'visibility': 'none' },
                'paint': {
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.7,
                    'fill-extrusion-color': [
                        'case',
                        ['boolean', ['feature-state', 'clicked'], false],
                        '#045a8d',
                        '#cccccc'
                    ]
                }
            });

            map.addLayer({
                'id': 'opt03',
                'type': 'fill-extrusion',
                'source': 'opt03-s',
                'layout': { 'visibility': 'none' },
                'paint': {
                    'fill-extrusion-height': ['get', 'height'],
                    'fill-extrusion-base': ['get', 'min_height'],
                    'fill-extrusion-opacity': 0.7,
                    'fill-extrusion-color': [
                        'case',
                        ['boolean', ['feature-state', 'clicked'], false],
                        '#045a8d',
                        '#cccccc'
                    ]
                }
            });

            var exId = null;
            map.on('click', 'existing', function (e) {
                if (e.features.length > 0) {
                    if (exId) {
                        map.setFeatureState(
                            { source: 'existing-s', id: exId },
                            { clicked: false }
                        );
                    }
                    exId = e.features[0].id;
                    map.setFeatureState(
                        { source: 'existing-s', id: exId },
                        { clicked: true }
                    );
                }
            });

            var opt01Id = null;
            map.on('click', 'opt01', function (e) {
                if (e.features.length > 0) {
                    if (opt01Id) {
                        map.setFeatureState(
                            { source: 'opt01-s', id: opt01Id },
                            { clicked: false }
                        );
                    }
                    opt01Id = e.features[0].id;
                    map.setFeatureState(
                        { source: 'opt01-s', id: opt01Id },
                        { clicked: true }
                    );
                }
            });

            var opt02Id = null;
            map.on('click', 'opt02', function (e) {
                if (e.features.length > 0) {
                    if (opt02Id) {
                        map.setFeatureState(
                            { source: 'opt02-s', id: opt02Id },
                            { clicked: false }
                        );
                    }
                    opt02Id = e.features[0].id;
                    map.setFeatureState(
                        { source: 'opt02-s', id: opt02Id },
                        { clicked: true }
                    );
                }
            });

            var opt03Id = null;
            map.on('click', 'opt03', function (e) {
                if (e.features.length > 0) {
                    if (opt03Id) {
                        map.setFeatureState(
                            { source: 'opt03-s', id: opt03Id },
                            { clicked: false }
                        );
                    }
                    opt03Id = e.features[0].id;
                    map.setFeatureState(
                        { source: 'opt03-s', id: opt03Id },
                        { clicked: true }
                    );
                }
            });

            map.on('mouseenter', 'existing', function () {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'existing', function () {
                map.getCanvas().style.cursor = '';
            });

            map.on('mouseenter', 'opt01', function () {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'opt01', function () {
                map.getCanvas().style.cursor = '';
            });

            map.on('mouseenter', 'opt02', function () {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'opt02', function () {
                map.getCanvas().style.cursor = '';
            });

            map.on('mouseenter', 'opt03', function () {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'opt03', function () {
                map.getCanvas().style.cursor = '';
            });

            var layer = document.getElementById('layer');

            layer.onchange = function () {

                var layerval = layer.value;

                if (layerval === 'existing') {
                    var others = ['opt01', 'opt02', 'opt03']
                } else if (layerval === 'opt01') {
                    var others = ['existing', 'opt02', 'opt03']
                } else if (layerval === 'opt02') {
                    var others = ['existing', 'opt01', 'opt03']
                } else {
                    var others = ['existing', 'opt01', 'opt02']
                };

                var visibility = map.getLayoutProperty(layerval, 'visibility');

                if (visibility !== 'visible') {
                    map.setLayoutProperty(layerval, 'visibility', 'visible');

                    others.forEach(function (lay) {
                        map.setLayoutProperty(lay, 'visibility', 'none');
                    });
                };


            };

            var area = [
                'interpolate',
                ['linear'],
                ['get', 'area'],
                0,
                '#F2F12D',
                50,
                '#EED322',
                100,
                '#E6B71E',
                150,
                '#DA9C20',
                200,
                '#CA8323',
                250,
                '#B86B25',
                300,
                '#A25626',
                350,
                '#8B4225',
                400,
                '#723122'
            ];

            var levels = [
                'interpolate',
                ['linear'],
                ['get', 'estimatedLevels'],
                0,
                '#ffffcc',
                1,
                '#a1dab4',
                2,
                '#41b6c4',
                3,
                '#2c7fb8',
                4,
                '#253494'
            ];

            var nostyling = [
                'case',
                ['boolean', ['feature-state', 'clicked'], false],
                '#045a8d',
                '#cccccc'
            ];

            var style = document.getElementById('style');

            var legend = {
                colorStops: [
                    00,
                    20,
                    40,
                    60,
                    80,
                    100
                ],
                colorPallete: [
                    '#f0f9e8',
                    '#ccebc5',
                    '#a8ddb5',
                    '#7bccc4',
                    '#43a2ca',
                    '#0868ac'
                ]
            };

            var gradientLegend = document.getElementById('legend-gradient');
            var steppedLegend = document.getElementById('legend-stepped');

            style.onchange = function (e) {

                if (style.value === "area") {
                    styler = area
                    gradientLegend.style.display = 'block';
                    steppedLegend.style.display = 'none';
                } else if (style.value === "nostyling") {
                    styler = nostyling
                    gradientLegend.style.display = 'none';
                    steppedLegend.style.display = 'none';
                } else {
                    styler = levels
                    gradientLegend.style.display = 'none';
                    steppedLegend.style.display = 'block';
                };

                map.setPaintProperty(layer.value, 'fill-extrusion-color', styler);

                $('#legend-low').text("test");
                $('#legend-mid').text("test2");
                $('#legend-high').text("test3");

                var gradientCss = '(left';

                for (var i = 0; i < legend.colorPallete.length; ++i) {
                    gradientCss += ',' + legend.colorPallete[i] + ' ' + legend.colorStops[i] + "%";
                    $('#gradient').css('background', '-webkit-linear-gradient' + gradientCss);
                };
            }
        });

    </script>

    <!-- Load Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

</body>

</html>